<!DOCTYPE html>
<html>
<head>
    <title>Project Springfield Town Uploader</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/public_townuploader.js"></script>
    <style>
        :root {
            --simpsons-yellow: #FED90F;
            --simpsons-blue: #3E67B1;
            --simpsons-red: #E53935;
            --simpsons-green: #7BC142;
            --simpsons-white: #ffffff;
            --simpsons-black: #333333;
            --simpsons-orange: #F57C00;
            --simpsons-panel: #FFF3D4;
            --simpsons-shadow: rgba(0, 0, 0, 0.3);
        }

        html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Comic Neue', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: url('images/background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: var(--simpsons-black);
            box-sizing: border-box;
        }
        
        /* Dark mode */
        body.dark-mode {
            --background: #1a1a2e;
            --panel-bg: #282838;
            --text-color: var(--simpsons-yellow);
            --text-primary: var(--simpsons-yellow);
            --text-secondary: var(--simpsons-orange);
            --border-color: var(--simpsons-blue);
            --hover-bg: #2d2d44;
            --input-bg: #1f1f2f;
            --editor-bg: #1E1E2E;
            background-color: var(--background);
            color: var(--text-color);
        }

        body.dark-mode .panel {
            background-color: var(--panel-bg);
            border-color: var(--border-color);
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="email"],
        body.dark-mode textarea,
        body.dark-mode select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        body.dark-mode button {
            background-color: var(--simpsons-blue);
            color: var(--simpsons-white);
        }

        body.dark-mode .response-message {
            background-color: var(--panel-bg);
            color: var(--text-color);
        }

        body.dark-mode .response-message.error {
            background-color: rgba(229, 57, 53, 0.2);
            color: var(--simpsons-red);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .panel {
            background-color: var(--simpsons-panel);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 10px var(--simpsons-shadow);
            border: 4px solid var(--simpsons-yellow);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: var(--simpsons-yellow);
            margin-bottom: 30px;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 0 var(--simpsons-black), 
                        -2px -2px 0 var(--simpsons-black),
                        2px -2px 0 var(--simpsons-black),
                        -2px 2px 0 var(--simpsons-black),
                        0 2px 0 var(--simpsons-black),
                        2px 0 0 var(--simpsons-black),
                        0 -2px 0 var(--simpsons-black),
                        -2px 0 0 var(--simpsons-black);
            letter-spacing: 1px;
        }

        h2 {
            color: var(--simpsons-blue);
            margin-top: 0;
            font-size: 24px;
            border-bottom: 2px solid var(--simpsons-yellow);
            padding-bottom: 8px;
            display: inline-block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--simpsons-blue);
            font-size: 16px;
        }

        input[type="text"], 
        input[type="email"], 
        select {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background-color: var(--simpsons-white);
            color: var(--simpsons-black);
            border: 3px solid var(--simpsons-blue);
            font-size: 16px;
            font-family: 'Comic Neue', cursive;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        input[type="text"]:focus, 
        input[type="email"]:focus, 
        select:focus {
            outline: none;
            border-color: var(--simpsons-orange);
            box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.25);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background-color: var(--simpsons-blue);
            color: var(--simpsons-white);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: 'Comic Neue', cursive;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #2A4B85;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background-color: #2A4B85;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1A3366;
        }

        button:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            text-align: center;
        }

        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: pointer;
            display: block;
        }

        .file-upload-btn {
            background-color: var(--simpsons-green);
            box-shadow: 0 4px 0 #4B913B;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 12px 20px;
        }

        .file-upload-btn:hover {
            background-color: #4B913B;
        }

        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: var(--simpsons-black);
            word-break: break-all;
        }

        .response-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }

        .success {
            background-color: var(--simpsons-green);
            color: white;
        }

        .error {
            background-color: var(--simpsons-red);
            color: white;
        }

        .help-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--simpsons-white);
            color: var(--simpsons-black);
            border: 2px solid var(--simpsons-yellow);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Decorative elements */
        .donut {
            position: fixed;
            width: 100px;
            height: 100px;
            z-index: -1;
            opacity: 0.8;
        }

        .donut1 {
            top: 10%;
            left: 5%;
            animation: float 8s ease-in-out infinite;
        }

        .donut2 {
            top: 20%;
            right: 5%;
            animation: float 10s ease-in-out infinite;
            animation-delay: 1s;
        }

        .donut3 {
            bottom: 10%;
            left: 10%;
            animation: float 9s ease-in-out infinite;
            animation-delay: 2s;
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(10deg);
            }
            100% {
                transform: translateY(0) rotate(0deg);
            }
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: var(--text-color);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Decorative donuts -->
    <svg class="donut donut1" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="#FFA0B7" />
        <circle cx="50" cy="50" r="15" fill="#FFF3D4" />
        <circle cx="30" cy="30" r="5" fill="#FF5252" />
        <circle cx="70" cy="40" r="5" fill="#FF5252" />
        <circle cx="60" cy="70" r="5" fill="#FF5252" />
    </svg>
    <svg class="donut donut2" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="#90CAF9" />
        <circle cx="50" cy="50" r="15" fill="#FFF3D4" />
        <circle cx="30" cy="30" r="5" fill="#3F51B5" />
        <circle cx="70" cy="40" r="5" fill="#3F51B5" />
        <circle cx="60" cy="70" r="5" fill="#3F51B5" />
    </svg>
    <svg class="donut donut3" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="#FFCC80" />
        <circle cx="50" cy="50" r="15" fill="#FFF3D4" />
        <circle cx="30" cy="30" r="5" fill="#FF9800" />
        <circle cx="70" cy="40" r="5" fill="#FF9800" />
        <circle cx="60" cy="70" r="5" fill="#FF9800" />
    </svg>

    <!-- Theme toggle button -->
    <div class="theme-toggle" id="theme-toggle">
        <i class="fas fa-moon"></i>
    </div>

    <div class="container">
        <h1>Project Springfield Town Uploader</h1>
        
        <div class="panel">
            <h2>Upload Your Town</h2>
            <p>Share your Springfield with the community! Upload your town file (.pb) and our town operators will review it.</p>
            
            <form id="town-upload-form">
                <div class="form-group">
                    <label for="email">Your Email:</label>
                    <input type="email" id="email" name="email" required placeholder="your.email@example.com">
                    <span class="help-text">We'll use this to notify you when your town is approved.</span>
                </div>
                
                <div class="file-upload">
                    <button type="button" class="file-upload-btn">
                        <i class="fas fa-upload" style="margin-right: 8px;"></i> Choose Town File (.pb)
                    </button>
                    <input type="file" id="town-file" name="town_file" accept=".pb" required>
                    <div id="file-name" class="file-name">No file selected</div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" id="submit-button">
                        <i class="fas fa-paper-plane" style="margin-right: 8px;"></i> Submit Town
                    </button>
                </div>
            </form>
            
            <div id="response-message" class="response-message" style="display: none;"></div>
        </div>
        
        <div class="panel">
            <h2>How It Works</h2>
            <ol style="padding-left: 20px;">
                <li><strong>Important:</strong> Rename your town file (.pb) to your email address (e.g., <code>youremail@example.com.pb</code>)</li>
                <li>Fill out the form with your email (same as the filename)</li>
                <li>Upload your renamed town file</li>
                <li>Submit your town for review</li>
                <li>Our town operators will review your submission</li>
                <li>Once approved, you will receive a confirmation email</li>
            </ol>
            <p><strong>Note:</strong> Your town file (.pb) is typically found in a zip file downloaded from a backup site. You'll need to extract the zip file first, then rename the .pb file to your email address before uploading. This renaming helps us process your submission more efficiently.</p>
        </div>
    </div>

    <footer>
        Server created and designed by BodNJenie&trade;
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle functionality
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            let isDarkMode = localStorage.getItem('darkMode') === 'true';
            
            // Set initial state
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
            
            // Toggle theme function
            themeToggle.addEventListener('click', function() {
                isDarkMode = !isDarkMode;
                // Toggle the dark-mode class on the body
                document.body.classList.toggle('dark-mode');
                // Save preference to localStorage
                localStorage.setItem('darkMode', isDarkMode);
                // Update the icon
                if (isDarkMode) {
                    themeIcon.className = 'fas fa-sun';
                } else {
                    themeIcon.className = 'fas fa-moon';
                }
            });
            
            // File upload UI
            const fileInput = document.getElementById('town-file');
            const fileNameDisplay = document.getElementById('file-name');
            const fileUploadBtn = document.querySelector('.file-upload-btn');
            
            fileUploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    fileNameDisplay.textContent = `${file.name} (${formatFileSize(file.size)})`;
                    fileNameDisplay.style.color = 'var(--simpsons-green)';
                } else {
                    fileNameDisplay.textContent = 'No file selected';
                    fileNameDisplay.style.color = 'var(--simpsons-black)';
                }
            });
            
            // Helper function to format file size
            function formatFileSize(bytes) {
                if (bytes < 1024) {
                    return bytes + ' bytes';
                } else if (bytes < 1024 * 1024) {
                    return (bytes / 1024).toFixed(2) + ' KB';
                } else {
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                }
            }
            
            // Form submission
            const form = document.getElementById('town-upload-form');
            const responseMessage = document.getElementById('response-message');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const townFile = fileInput.files[0];
                
                // Validate required fields
                if (!email) {
                    showResponse('Please fill out all required fields', true);
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showResponse('Please enter a valid email address', true);
                    return;
                }
                
                // Validate town file
                const fileValidation = PublicTownUploader.validateTownFile(townFile);
                if (!fileValidation.success) {
                    showResponse(fileValidation.message, true);
                    return;
                }
                
                const submitButton = document.getElementById('submit-button');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                
                try {
                    const formData = new FormData();
                    formData.append('email', email);
                    formData.append('town_file', townFile);
                    
                    const result = await PublicTownUploader.uploadTown(formData);
                    
                    if (result.success) {
                        showResponse(`Your town has been successfully submitted for review! We'll notify you when it's approved. ${result.uploadId ? 'Your upload ID is: ' + result.uploadId : ''}`, false);
                        form.reset();
                        fileNameDisplay.textContent = 'No file selected';
                        
                        // Store the upload ID in localStorage for future reference
                        if (result.uploadId) {
                            const uploads = JSON.parse(localStorage.getItem('pendingTownUploads') || '[]');
                            uploads.push({
                                id: result.uploadId,
                                email: email,
                                date: new Date().toISOString()
                            });
                            localStorage.setItem('pendingTownUploads', JSON.stringify(uploads));
                        }
                    } else {
                        showResponse(result.message || 'An error occurred while uploading your town. Please try again.', true);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showResponse('An error occurred while uploading your town. Please try again.', true);
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i> Submit Town';
                }
            });
            
            function showResponse(message, isError) {
                responseMessage.textContent = message;
                responseMessage.className = 'response-message ' + (isError ? 'error' : 'success');
                responseMessage.style.display = 'block';
                
                // Scroll to the response message
                responseMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Hide the message after 10 seconds
                setTimeout(() => {
                    responseMessage.style.display = 'none';
                }, 10000);
            }
        });
    </script>
</body>
</html>
