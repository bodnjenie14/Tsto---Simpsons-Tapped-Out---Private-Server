<!DOCTYPE html>
<html>
<head>
    <title>Admin Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/login.js"></script>
    <style>
        :root {
            --simpsons-yellow: #FED90F;
            --simpsons-blue: #3E67B1;
            --simpsons-red: #E53935;
            --simpsons-green: #7BC142;
            --simpsons-white: #ffffff;
            --simpsons-black: #333333;
            --simpsons-orange: #F57C00;
            --simpsons-panel: #FFF3D4;
            --simpsons-shadow: rgba(0, 0, 0, 0.3);
        }

        html {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Comic Neue', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: url('images/background.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            color: var(--simpsons-black);
            box-sizing: border-box;
        }
        
        /* Dark mode */
        body.dark-mode {
            --background: #1a1a2e;
            --panel-bg: #282838;
            --text-color: var(--simpsons-yellow);
            --text-primary: var(--simpsons-yellow);
            --text-secondary: var(--simpsons-orange);
            --border-color: var(--simpsons-blue);
            --hover-bg: #2d2d44;
            --input-bg: #1f1f2f;
            --editor-bg: #1E1E2E;
            background-color: var(--background);
            color: var(--text-color);
        }
        
        body.dark-mode .panel {
            background-color: var(--panel-bg);
            border-color: var(--text-color);
        }
        
        body.dark-mode h2 {
            color: var(--text-color);
            border-bottom-color: var(--text-color);
        }
        
        body.dark-mode .form-group label {
            color: var(--text-color);
        }
        
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        body.dark-mode .nav-bar {
            background-color: #1a1a2e;
            border-color: var(--simpsons-yellow);
        }
        
        body.dark-mode .nav-button {
            color: var(--simpsons-yellow);
            background-color: transparent;
        }
        
        body.dark-mode .nav-button.active {
            background-color: var(--simpsons-blue);
            color: var(--simpsons-yellow);
        }
        
        body.dark-mode .nav-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        body.dark-mode .nav-title {
            color: var(--simpsons-yellow);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .panel {
            background-color: var(--simpsons-panel);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 10px var(--simpsons-shadow);
            border: 4px solid var(--simpsons-yellow);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: var(--simpsons-yellow);
            margin-bottom: 30px;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 0 var(--simpsons-black), 
                        -2px -2px 0 var(--simpsons-black),
                        2px -2px 0 var(--simpsons-black),
                        -2px 2px 0 var(--simpsons-black),
                        0 2px 0 var(--simpsons-black),
                        2px 0 0 var(--simpsons-black),
                        0 -2px 0 var(--simpsons-black),
                        -2px 0 0 var(--simpsons-black);
            letter-spacing: 1px;
        }

        h2 {
            color: var(--simpsons-blue);
            margin-top: 0;
            font-size: 24px;
            border-bottom: 2px solid var(--simpsons-yellow);
            padding-bottom: 8px;
            display: inline-block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--simpsons-blue);
            font-size: 16px;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background-color: var(--simpsons-white);
            color: var(--simpsons-black);
            border: 3px solid var(--simpsons-blue);
            font-size: 16px;
            font-family: 'Comic Neue', cursive;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--simpsons-orange);
            box-shadow: 0 0 0 3px rgba(245, 124, 0, 0.25);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background-color: var(--simpsons-blue);
            color: var(--simpsons-white);
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: 'Comic Neue', cursive;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #2A4B85;
            position: relative;
            top: 0;
        }

        button:hover {
            background-color: #5482D0;
            top: -2px;
            box-shadow: 0 6px 0 #2A4B85;
        }
        
        button:active {
            top: 4px;
            box-shadow: 0 0 0 #2A4B85;
        }

        .response {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(123, 193, 66, 0.2);
            border-left: 4px solid var(--simpsons-green);
            display: none;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .error {
            background-color: rgba(229, 57, 53, 0.2);
            border-left: 4px solid var(--simpsons-red);
        }
        
        /* Navigation Bar Styles */
        .nav-bar {
            background-color: var(--simpsons-blue);
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px var(--simpsons-shadow);
            border: 4px solid var(--simpsons-yellow);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-button {
            padding: 8px 15px;
            background-color: var(--simpsons-yellow);
            color: var(--simpsons-blue);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            transition: none;
            cursor: pointer;
            position: static;
        }
        
        .nav-button:hover {
            background-color: var(--simpsons-white);
        }
        
        .nav-button.active {
            background-color: var(--simpsons-white);
            box-shadow: 0 2px 4px var(--simpsons-shadow);
        }
        
        .logout-btn {
            background-color: var(--simpsons-red);
            color: white;
        }
        
        .user-info {
            color: var(--simpsons-white);
            font-weight: bold;
        }

        /* Theme toggle button with NO animations or hover effects */
        .theme-toggle {
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            background-color: var(--simpsons-yellow) !important;
            color: var(--simpsons-black) !important;
            border: 2px solid var(--simpsons-blue) !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 24px !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
            z-index: 1000 !important;
            font-weight: bold !important;
            /* Explicitly disable all animations and transitions */
            transition: none !important;
            transform: none !important;
            animation: none !important;
        }
        
        /* Remove hover effect completely */
        .theme-toggle:hover {
            background-color: inherit;
        }
        
        /* Dark mode theme toggle with NO animations or hover effects */
        body.dark-mode .theme-toggle {
            background-color: #333 !important;
            color: var(--simpsons-yellow) !important;
            border-color: var(--simpsons-yellow) !important;
        }
        
        /* Remove dark mode hover effect completely */
        body.dark-mode .theme-toggle:hover {
            background-color: #333;
        }

        /* Static theme toggle button with no effects */
        .static-theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--simpsons-yellow);
            color: var(--simpsons-black);
            border: 2px solid var(--simpsons-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: bold;
        }
        
        body.dark-mode .static-theme-toggle {
            background-color: #333;
            color: var(--simpsons-yellow);
            border-color: var(--simpsons-yellow);
        }

        /* Currency editor specific styles */
        .currency-editor {
            max-width: 500px;
            margin: 0 auto;
        }

        .currency-editor .form-group {
            margin-bottom: 20px;
        }

        .success-message, .error-message {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            margin: 15px auto;
            font-weight: bold;
            max-width: 500px;
        }

        .success-message {
            background-color: rgba(123, 193, 66, 0.2);
            border-left: 4px solid var(--simpsons-green);
            color: var(--simpsons-green);
        }

        .error-message {
            background-color: rgba(229, 57, 53, 0.2);
            border-left: 4px solid var(--simpsons-red);
            color: var(--simpsons-red);
        }

        #messageContainer {
            height: 50px;
            margin-bottom: 10px;
        }

        /* Decorative donuts */
        .donut {
            position: fixed;
            width: 60px;
            height: 60px;
            z-index: -1;
            opacity: 0.8;
            animation: float 6s infinite ease-in-out;
        }

        .donut1 {
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .donut2 {
            top: 20%;
            right: 10%;
            animation-delay: 2s;
        }

        .donut3 {
            bottom: 15%;
            left: 15%;
            animation-delay: 4s;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(10deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
    </style>
</head>
<body>
    <!--decorative donuts-->
    <svg class="donut donut1" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="#FFA0B7" />
        <circle cx="50" cy="50" r="15" fill="#FFF3D4" />
    </svg>
    <svg class="donut donut2" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="#85C8F2" />
        <circle cx="50" cy="50" r="15" fill="#FFF3D4" />
    </svg>
    <svg class="donut donut3" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="#7BC142" />
        <circle cx="50" cy="50" r="15" fill="#FFF3D4" />
    </svg>
    
    <button class="theme-toggle" id="theme-toggle">
        <i class="fas fa-moon"></i>
    </button>

    <div class="nav-bar">
        <div class="nav-container">
            <div class="nav-buttons">
                <a href="/dashboard.html" class="nav-button">Dashboard</a>
                <a href="/town_operations.html" class="nav-button">Town Operations</a>
                <a href="/game_config.html" class="nav-button">Game Config</a>
                <a href="/user_management.html" class="nav-button active">User Management</a>
                <a href="/user_search.html" class="nav-button">User Search</a>
                <a href="/admin_management.html" class="nav-button">Admin Management</a>
                <a href="#" onclick="logout(); return false;" class="nav-button logout-btn">Logout</a>
            </div>
            <div class="user-info">
                <span id="current-user">Loading...</span>
            </div>
        </div>
    </div>

    <h1>User Management</h1>
    
    <div class="container">
        <div class="panel">
            <div class="search-container" style="margin-bottom: 20px;">
                <input type="text" id="userSearch" placeholder="Search users by email..." style="width: 100%; padding: 10px; border-radius: 10px; border: 3px solid var(--simpsons-blue); font-size: 16px;">
            </div>
            <h2>User Editor</h2>
            <div id="messageContainer"></div>
            <div class="currency-editor">
                <div class="form-group">
                    <label for="userSelect">Select User:</label>
                    <select id="userSelect" onchange="userSelected()">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email/Username:</label>
                    <input type="text" id="userEmail" readonly>
                </div>
                <div class="form-group">
                    <label for="displayName">Display Name:</label>
                    <input type="text" id="displayName" placeholder="Enter display name">
                </div>
                <div class="form-group">
                    <label for="landSize">Land File Size:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="landSize" readonly style="flex-grow: 1;">
                        <button id="deleteTownButton" onclick="deleteTown()" style="background-color: var(--simpsons-red); color: white;">
                            <i class="fas fa-trash"></i> Delete Town
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="currencyAmount">Donut Amount:</label>
                    <input type="number" id="currencyAmount" min="0">
                </div>
                <button id="updateButton" onclick="updateUserCurrency()">Update User Profile</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggleButton = document.getElementById('theme-toggle');
            const themeIcon = themeToggleButton.querySelector('i');
            let isDarkMode = localStorage.getItem('darkMode') === 'true';
            
            // Set initial state
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }

            function toggleTheme() {
                isDarkMode = !isDarkMode;
                // Toggle the dark-mode class on the body
                document.body.classList.toggle('dark-mode');
                // Save preference to localStorage
                localStorage.setItem('darkMode', isDarkMode);
                // Update the icon
                if (isDarkMode) {
                    themeIcon.className = 'fas fa-sun';
                } else {
                    themeIcon.className = 'fas fa-moon';
                }
            }

            themeToggleButton.addEventListener('click', toggleTheme);
            
            // Load users
            loadUsers();
            
            // Update current user display
            updateCurrentUser();
        });

        // Function to update the current user display in the navigation bar
        function updateCurrentUser() {
            // Get the session token from cookies
            const cookies = document.cookie.split(';');
            let sessionToken = '';
            
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('tsto_session=')) {
                    sessionToken = cookie.substring('tsto_session='.length);
                    break;
                }
            }
            
            if (sessionToken) {
                // Since we're on a protected page, we know we're authenticated
                fetch('/api/auth/validate_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: sessionToken })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.username) {
                        document.getElementById('current-user').innerHTML = `<i class="fas fa-user"></i> Logged in as: ${data.username}`;
                    } else {
                        // If we're on this page, we must be logged in, so get username from localStorage
                        const username = localStorage.getItem('tsto_username') || 'User';
                        document.getElementById('current-user').innerHTML = `<i class="fas fa-user"></i> Logged in as: ${username}`;
                    }
                    
                    // Highlight the active page in the navigation
                    highlightActivePage();
                })
                .catch(error => {
                    console.error('Error validating session:', error);
                    // Fallback to showing logged in status without username
                    document.getElementById('current-user').innerHTML = `<i class="fas fa-user"></i> Logged in`;
                });
            } else {
                // Fallback - if we're on a protected page, we must be logged in
                document.getElementById('current-user').innerHTML = `<i class="fas fa-user"></i> Logged in`;
            }
        }
        
        // Function to highlight the active page in the navigation
        function highlightActivePage() {
            const currentPath = window.location.pathname;
            const navButtons = document.querySelectorAll('.nav-button');
            
            navButtons.forEach(button => {
                const href = button.getAttribute('href');
                if (currentPath === href || 
                    (currentPath === '/currency_editor.html' && href === '/currency_editor.html') ||
                    (currentPath === '/currency_editor' && href === '/currency_editor.html')) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        // Function to handle logout
        async function logoutUser() {
            try {
                // First, try the API endpoint
                const response = await fetch('/logout', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // Clear session token from cookies
                document.cookie = 'tsto_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                // Clear username from localStorage
                localStorage.removeItem('tsto_username');
                
                // Redirect to login page
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                // Even if there's an error, try to redirect to login
                window.location.href = '/login.html';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/list_users');
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                const data = await response.json();
                const userSelect = document.getElementById('userSelect');
                
                // Clear existing options except the first one
                while (userSelect.options.length > 1) {
                    userSelect.remove(1);
                }

                // Add users to dropdown
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(user);
                    // Show display name if available, otherwise show username
                    const displayText = user.displayName ? 
                        `${user.displayName} (${user.username})` : 
                        (user.isLegacy ? 'Legacy User (mytown)' : user.username);
                    option.textContent = displayText;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Error loading users: ' + error.message, false);
            }
        }

        function userSelected() {
            const userSelect = document.getElementById('userSelect');
            const userEmail = document.getElementById('userEmail');
            const displayName = document.getElementById('displayName');
            const landSize = document.getElementById('landSize');
            const currencyAmount = document.getElementById('currencyAmount');
            
            if (userSelect.value) {
                const userData = JSON.parse(userSelect.value);
                userEmail.value = userData.username;
                displayName.value = userData.displayName || '';
                landSize.value = userData.landSizeFormatted || (userData.landSize ? userData.landSize + ' bytes' : 'Unknown');
                currencyAmount.value = userData.currency || 0;
            } else {
                userEmail.value = '';
                displayName.value = '';
                landSize.value = '';
                currencyAmount.value = '';
            }
        }

        function showMessage(message, isSuccess) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = isSuccess ? 'success-message' : 'error-message';
            messageElement.textContent = message;
            
            // Clear previous messages
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageElement);
            
            // Auto-clear message after 5 seconds
            setTimeout(() => {
                messageElement.remove();
            }, 5000);
        }

        async function deleteTown() {
            const email = document.getElementById('userEmail').value;
            
            if (!email) {
                showMessage('Please select a user first', false);
                return;
            }
            
            // Ask for confirmation
            if (!confirm(`Are you sure you want to delete the town for ${email}? This action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch('/delete_town', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showMessage(`Successfully deleted town for ${email}`, true);
                    // Refresh the user list to show updated information
                    await loadUsers();
                } else {
                    showMessage(`Error: ${data.error || 'Failed to delete town'}`, false);
                }
            } catch (error) {
                showMessage('Failed to delete town: ' + error.message, false);
            }
        }
        
        async function updateUserCurrency() {
            const email = document.getElementById('userEmail').value;
            const displayName = document.getElementById('displayName').value;
            const amount = parseInt(document.getElementById('currencyAmount').value);

            if (!email || isNaN(amount)) {
                showMessage('Please fill in both email and amount fields', false);
                return;
            }

            try {
                const response = await fetch('/edit_user_currency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        displayName: displayName,
                        amount: amount
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    let successMessage = `Successfully updated donuts for ${email} to ${amount}`;
                    if (displayName) {
                        successMessage += ` and updated display name to "${displayName}"`;
                    }
                    showMessage(successMessage, true);
                    // Refresh the user list to show updated currency
                    await loadUsers();
                } else {
                    showMessage(`Error: ${data.message}`, false);
                }
            } catch (error) {
                showMessage('Failed to update currency: ' + error.message, false);
            }
        }
        
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const userSelect = document.getElementById('userSelect');
            
            // Find first matching option
            for (let i = 1; i < userSelect.options.length; i++) {
                const option = userSelect.options[i];
                const userData = JSON.parse(option.value);
                const email = userData.username.toLowerCase();
                
                if (email.includes(searchTerm)) {
                    userSelect.selectedIndex = i;
                    userSelected(); // Trigger the selection handler
                    return;
                }
            }
            
            // If no match found, reset to default
            if (searchTerm === '') {
                userSelect.selectedIndex = 0;
                userSelected();
            }
        });
    </script>
	    <footer style="text-align: center; padding: 20px; margin-top: 30px; color: var(--text-primary); font-size: 14px; font-family: 'Comic Neue', cursive;">
     Server created and designed by BodNJenie&trade;
    </footer>
</body>
</html>
